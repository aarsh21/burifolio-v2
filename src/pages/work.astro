---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'

// Get work collection with error handling
let workList: any[] = []
try {
  workList = await getCollection('work')
} catch (e) {
  console.error('Error loading work collection:', e)
}

const sortedWork = workList.sort((a, b) => {
  // Sort current jobs first, then by start date (most recent first)
  if (a.data.isCurrent && !b.data.isCurrent) return -1
  if (!a.data.isCurrent && b.data.isCurrent) return 1
  return b.data.start_date.localeCompare(a.data.start_date)
})
---

<Layout class="max-w-4xl">
  <PageHead slot="head" title="Work Experience" />
  <Breadcrumbs items={[{ label: 'Work', icon: 'lucide:briefcase' }]} />
  
  <section class="flex flex-col gap-y-8">
    <!-- Header -->
    <div class="relative border-2 border-foreground bg-background p-6 shadow-brutal">
      <!-- Corner accents -->
      <div class="absolute -left-1 -top-1 h-4 w-4 border-l-4 border-t-4 border-accent"></div>
      <div class="absolute -right-1 -top-1 h-4 w-4 border-r-4 border-t-4 border-accent"></div>
      
      <div class="mb-2 inline-block border-2 border-foreground bg-accent px-2 py-0.5 text-xs font-bold uppercase text-accent-foreground">
        Career
      </div>
      <h1 class="text-3xl font-bold uppercase tracking-tight sm:text-4xl">
        Work Experience
      </h1>
      <p class="mt-2 text-muted-foreground">
        My professional journey through the tech industry.
      </p>
    </div>
    
    <!-- Timeline -->
    <div class="relative">
      <!-- Vertical line -->
      <div class="absolute left-4 top-0 h-full w-0.5 bg-foreground sm:left-6"></div>
      
      <div class="stagger-children flex flex-col gap-8">
        {
          sortedWork.length === 0 ? (
            <div class="ml-12 border-2 border-foreground bg-background p-6 text-muted-foreground italic sm:ml-16">
              Work experience is currently being updated...
            </div>
          ) : (
            sortedWork.map((job, index) => (
              <div class="relative pl-12 sm:pl-16" style={`animation-delay: ${index * 100}ms`}>
                <!-- Timeline dot -->
                <div class={`absolute left-2 top-6 h-5 w-5 border-2 border-foreground sm:left-4 ${job.data.isCurrent ? 'bg-accent' : 'bg-background'}`}>
                  {job.data.isCurrent && (
                    <span class="absolute inset-0 animate-ping bg-accent opacity-75"></span>
                  )}
                </div>
                
                <!-- Card -->
                <div class="brutal-hover border-2 border-foreground bg-background transition-all">
                  <!-- Header -->
                  <div class="border-b-2 border-foreground p-4 sm:p-5">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                      <div>
                        {job.data.isCurrent && (
                          <span class="mb-2 inline-flex items-center gap-1 border border-additive bg-additive/10 px-2 py-0.5 text-xs font-bold uppercase text-additive">
                            <span class="h-1.5 w-1.5 animate-pulse rounded-full bg-additive"></span>
                            Current
                          </span>
                        )}
                        <h3 class="text-lg font-bold uppercase tracking-tight">
                          <Link href={job.data.link} external class="link-underline hover:text-accent">
                            {job.data.position}
                          </Link>
                        </h3>
                        <p class="text-muted-foreground">{job.data.company}</p>
                      </div>
                      <div class="flex items-center gap-2 border border-foreground/50 bg-muted px-3 py-1 text-xs font-medium uppercase sm:text-right">
                        <Icon name="lucide:calendar" class="h-3 w-3 opacity-60" />
                        <span>{job.data.start_date} - {job.data.end_date}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Responsibilities -->
                  <div class="p-4 sm:p-5">
                    <h4 class="mb-3 flex items-center gap-2 text-xs font-bold uppercase tracking-wide text-muted-foreground">
                      <Icon name="lucide:list-checks" class="h-3 w-3" />
                      Key Responsibilities
                    </h4>
                    <ul class="space-y-2 text-sm">
                      {job.data.responsibilities.map((responsibility: string) => (
                        <li class="flex gap-3">
                          <span class="mt-1.5 h-1.5 w-1.5 shrink-0 bg-accent"></span>
                          <span class="text-muted-foreground">{responsibility}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
            ))
          )
        }
      </div>
    </div>
    
    <!-- CTA Section -->
    <div class="border-2 border-foreground bg-foreground p-5 text-center text-background">
      <Icon name="lucide:mail" class="mx-auto mb-3 h-8 w-8" />
      <h3 class="mb-2 text-lg font-bold uppercase">Interested in working together?</h3>
      <p class="mb-4 text-sm opacity-80">
        I'm always open to discussing new opportunities.
      </p>
      <a 
        href="https://cal.com/aarsh.hyorinmaru.me/30min"
        target="_blank"
        rel="noopener noreferrer"
        class="brutal-hover inline-flex items-center gap-2 border-2 border-background bg-background px-5 py-2 text-sm font-bold uppercase text-foreground transition-colors hover:bg-accent hover:text-accent-foreground"
      >
        <span>Schedule a Call</span>
        <Icon name="lucide:calendar" class="h-4 w-4" />
      </a>
    </div>
  </section>
</Layout>
