---
import { ScrollArea } from '@/components/ui/scroll-area'
import type { TOCSection } from '@/lib/data-utils'
import { getParentId, isSubpost } from '@/lib/data-utils'
import { cn, getHeadingMargin } from '@/lib/utils'

type Props = {
  sections: TOCSection[]
  currentPostId: string
}

const { sections, currentPostId } = Astro.props
const isCurrentSubpost = isSubpost(currentPostId)
const parentId = isCurrentSubpost ? getParentId(currentPostId) : currentPostId
---

{
  sections.length > 0 && (
    <div
      id="toc-sidebar-container"
      class="sticky top-20 col-start-1 row-span-1 mr-8 ml-auto hidden h-[calc(100vh-5rem)] max-w-xs xl:block"
    >
      <div class="border-2 border-foreground bg-background">
        <!-- Header -->
        <div class="border-b-2 border-foreground bg-muted px-4 py-3">
          <span class="text-xs font-bold uppercase tracking-wide">Table of Contents</span>
        </div>
        
        <ScrollArea
          client:load
          className="flex max-h-[calc(100vh-12rem)] flex-col overflow-y-auto"
          type="hover"
          data-toc-scroll-area
        >
          <div class="flex flex-col gap-1 p-3">
            {sections.map((section, index) => {
              const isFirstSubpost =
                section.type === 'subpost' &&
                (index === 0 || sections[index - 1].type === 'parent')

              return (
                <>
                  {isFirstSubpost && (
                    <div class="mt-3 mb-2 flex items-center gap-2">
                      <div class="h-px flex-1 bg-foreground/30" />
                      <span class="text-muted-foreground text-[10px] font-bold uppercase tracking-wider">
                        Subposts
                      </span>
                      <div class="h-px flex-1 bg-foreground/30" />
                    </div>
                  )}

                  {section.type === 'parent' ? (
                    <ul class="flex list-none flex-col">
                      {section.headings.map((heading) => (
                        <li
                          class={cn(
                            'text-xs transition-colors',
                            getHeadingMargin(heading.depth),
                            isCurrentSubpost
                              ? 'text-foreground/40'
                              : 'text-foreground/60 hover:text-foreground',
                          )}
                        >
                          <a
                            href={
                              isCurrentSubpost
                                ? `/blog/${parentId}#${heading.slug}`
                                : `#${heading.slug}`
                            }
                            class="block py-1 transition-colors hover:text-accent"
                            data-heading-link={heading.slug}
                          >
                            {heading.text}
                          </a>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div
                      class={cn(
                        'border-l-2 pl-3 py-2',
                        section.subpostId === currentPostId 
                          ? 'border-accent bg-accent/10' 
                          : 'border-foreground/20',
                      )}
                    >
                      <ul class="flex list-none flex-col">
                        <li
                          class={cn(
                            'text-xs font-bold uppercase tracking-wide',
                            section.subpostId === currentPostId
                              ? 'text-foreground'
                              : 'text-foreground/50',
                          )}
                        >
                          <a
                            href={
                              section.subpostId === currentPostId
                                ? '#'
                                : `/blog/${section.subpostId}`
                            }
                            class="block py-1 transition-colors hover:text-accent"
                            data-heading-link={
                              section.subpostId === currentPostId
                                ? 'top'
                                : `${section.subpostId}-top`
                            }
                          >
                            {section.title}
                          </a>
                        </li>
                        {section.headings.map((heading) => (
                          <li
                            class={cn(
                              'text-[11px]',
                              getHeadingMargin(heading.depth),
                              section.subpostId === currentPostId
                                ? 'text-foreground/60 hover:text-foreground'
                                : 'text-foreground/30 hover:text-foreground/50',
                            )}
                          >
                            <a
                              href={
                                section.subpostId === currentPostId
                                  ? `#${heading.slug}`
                                  : `/blog/${section.subpostId}#${heading.slug}`
                              }
                              class="block py-0.5 transition-colors hover:text-accent"
                              data-heading-link={
                                section.subpostId === currentPostId
                                  ? heading.slug
                                  : `${section.subpostId}-${heading.slug}`
                              }
                            >
                              {heading.text}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </>
              )
            })}
          </div>
        </ScrollArea>
      </div>
    </div>
  )
}

<script>
  import { TOCController } from '@/lib/toc'

  document.addEventListener('astro:page-load', () => TOCController.init())
  document.addEventListener('astro:after-swap', () => {
    TOCController.cleanup()
    TOCController.init()
  })
  document.addEventListener('astro:before-swap', () => TOCController.cleanup())
</script>
