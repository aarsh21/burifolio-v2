---
import Link from '@/components/Link.astro'
import { ScrollArea } from '@/components/ui/scroll-area'
import {
  getCombinedReadingTime,
  getParentId,
  getParentPost,
  getPostById,
  getPostReadingTime,
  getSubpostsForParent,
  isSubpost,
} from '@/lib/data-utils'

const { parentId } = Astro.props
const currentPostId = Astro.params.id as string
const isCurrentSubpost = isSubpost(currentPostId)
const rootParentId = isCurrentSubpost ? getParentId(currentPostId) : parentId

const currentPost = !isCurrentSubpost ? await getPostById(currentPostId) : null
const subposts = await getSubpostsForParent(rootParentId)
const parentPost = isCurrentSubpost ? await getParentPost(currentPostId) : null

const activePost = parentPost || currentPost
const isActivePost = activePost?.id === currentPostId

const activePostReadingTime = activePost
  ? await getPostReadingTime(activePost.id)
  : null
const activePostCombinedReadingTime =
  activePost && subposts.length > 0
    ? await getCombinedReadingTime(activePost.id)
    : null
const subpostsWithReadingTime = await Promise.all(
  subposts.map(async (subpost) => ({
    ...subpost,
    readingTime: await getPostReadingTime(subpost.id),
  })),
)
---

<div
  id="subposts-sidebar-container"
  class="sticky top-20 col-start-3 row-span-1 mr-auto ml-8 hidden h-[calc(100vh-5rem)] max-w-md xl:block"
>
  <!-- Brutalist sidebar container -->
  <div class="relative">
    <!-- Corner accents -->
    <div
      class="absolute -top-1 -left-1 h-2 w-2 border-t-2 border-l-2 border-accent"
    >
    </div>
    <div
      class="absolute -top-1 -right-1 h-2 w-2 border-t-2 border-r-2 border-accent"
    >
    </div>
    <div
      class="absolute -bottom-1 -left-1 h-2 w-2 border-b-2 border-l-2 border-accent"
    >
    </div>
    <div
      class="absolute -bottom-1 -right-1 h-2 w-2 border-b-2 border-r-2 border-accent"
    >
    </div>

    <div class="border-2 border-border bg-card shadow-brutal">
      <!-- Header bar -->
      <div
        class="flex items-center justify-between gap-2 px-3 py-2 bg-muted border-b-2 border-border"
      >
        <span class="font-mono text-xs font-bold uppercase tracking-wide">
          Series
        </span>
        <span
          class="px-1.5 py-0.5 bg-accent text-accent-foreground font-mono text-xs font-bold"
        >
          {subposts.length + 1}
        </span>
      </div>

      <ScrollArea
        client:load
        className="flex max-h-[calc(100vh-12rem)] flex-col overflow-y-auto"
        data-subposts-sidebar-scroll
      >
        <div class="p-3">
          <ul class="space-y-1">
            {
              activePost && (
                <li>
                  {isActivePost ? (
                    <div class="subposts-sidebar-active-item flex items-center gap-3 border-2 border-accent bg-accent/10 px-3 py-2">
                      <div class="w-6 h-6 flex items-center justify-center bg-accent text-accent-foreground font-mono text-xs font-bold flex-shrink-0">
                        01
                      </div>
                      <div class="flex flex-col min-w-0">
                        <span class="font-bold text-sm line-clamp-2 text-pretty">
                          {activePost.data.title}
                        </span>
                        {activePostReadingTime && (
                          <span class="text-muted-foreground font-mono text-xs">
                            {activePostReadingTime}
                            {activePostCombinedReadingTime &&
                              activePostCombinedReadingTime !==
                                activePostReadingTime && (
                                <span class="text-accent">
                                  {' '}
                                  ({activePostCombinedReadingTime} total)
                                </span>
                              )}
                          </span>
                        )}
                      </div>
                    </div>
                  ) : (
                    <Link
                      href={`/blog/${activePost.id}#post-title`}
                      class="subposts-sidebar-link flex items-center gap-3 border-2 border-border hover:border-accent px-3 py-2 transition-colors group"
                    >
                      <div class="w-6 h-6 flex items-center justify-center bg-muted border border-border group-hover:bg-accent group-hover:text-accent-foreground font-mono text-xs flex-shrink-0 transition-colors">
                        01
                      </div>
                      <div class="flex flex-col min-w-0">
                        <span class="text-muted-foreground group-hover:text-foreground text-sm line-clamp-2 text-pretty transition-colors">
                          {activePost.data.title}
                        </span>
                        {activePostReadingTime && (
                          <span class="text-muted-foreground/80 font-mono text-xs">
                            {activePostReadingTime}
                            {activePostCombinedReadingTime &&
                              activePostCombinedReadingTime !==
                                activePostReadingTime && (
                                <span>
                                  {' '}
                                  ({activePostCombinedReadingTime} total)
                                </span>
                              )}
                          </span>
                        )}
                      </div>
                    </Link>
                  )}
                </li>
              )
            }

            {
              subpostsWithReadingTime.length > 0 && (
                <li class="ml-6 space-y-1 border-l-2 border-border pl-3">
                  {subpostsWithReadingTime.map((subpost, index) =>
                    currentPostId === subpost.id ? (
                      <div class="subposts-sidebar-active-item flex items-center gap-3 border-2 border-accent bg-accent/10 px-3 py-2">
                        <div class="w-6 h-6 flex items-center justify-center bg-accent text-accent-foreground font-mono text-xs font-bold flex-shrink-0">
                          {String(index + 2).padStart(2, '0')}
                        </div>
                        <div class="flex flex-col min-w-0">
                          <span class="font-bold text-sm line-clamp-2 text-pretty">
                            {subpost.data.title}
                          </span>
                          <span class="text-muted-foreground font-mono text-xs">
                            {subpost.readingTime}
                          </span>
                        </div>
                      </div>
                    ) : (
                      <Link
                        href={`/blog/${subpost.id}`}
                        class="subposts-sidebar-link flex items-center gap-3 border-2 border-border hover:border-accent px-3 py-2 transition-colors group"
                      >
                        <div class="w-6 h-6 flex items-center justify-center bg-muted border border-border group-hover:bg-accent group-hover:text-accent-foreground font-mono text-xs flex-shrink-0 transition-colors">
                          {String(index + 2).padStart(2, '0')}
                        </div>
                        <div class="flex flex-col min-w-0">
                          <span class="text-muted-foreground group-hover:text-foreground text-sm line-clamp-2 text-pretty transition-colors">
                            {subpost.data.title}
                          </span>
                          <span class="text-muted-foreground/80 font-mono text-xs">
                            {subpost.readingTime}
                          </span>
                        </div>
                      </Link>
                    ),
                  )}
                </li>
              )
            }
          </ul>
        </div>
      </ScrollArea>
    </div>
  </div>
</div>

<script>
  class SidebarState {
    scrollArea: HTMLElement | null = null
    sidebarScrollArea: HTMLElement | null = null

    reset() {
      this.scrollArea = null
      this.sidebarScrollArea = null
    }
  }

  const state = new SidebarState()

  class SidebarScrollMask {
    static update() {
      if (!state.scrollArea || !state.sidebarScrollArea) return

      const { scrollTop, scrollHeight, clientHeight } = state.scrollArea
      const threshold = 5
      const isAtTop = scrollTop <= threshold
      const isAtBottom = scrollTop >= scrollHeight - clientHeight - threshold

      state.sidebarScrollArea.classList.toggle('mask-t-from-90%', !isAtTop)
      state.sidebarScrollArea.classList.toggle('mask-b-from-90%', !isAtBottom)
    }
  }

  class SidebarScroll {
    static toActive() {
      if (!state.scrollArea) return

      const activeItem = state.scrollArea.querySelector(
        '.subposts-sidebar-active-item',
      )
      if (!activeItem) {
        return
      }

      const { top: areaTop, height: areaHeight } =
        state.scrollArea.getBoundingClientRect()
      const { top: itemTop, height: itemHeight } =
        activeItem.getBoundingClientRect()

      const currentItemTop = itemTop - areaTop + state.scrollArea.scrollTop
      const targetScroll = Math.max(
        0,
        Math.min(
          currentItemTop - (areaHeight - itemHeight) / 2,
          state.scrollArea.scrollHeight - state.scrollArea.clientHeight,
        ),
      )

      state.scrollArea.scrollTop = targetScroll
    }
  }

  class SidebarController {
    static init() {
      state.reset()

      const sidebarContainer = document.getElementById(
        'subposts-sidebar-container',
      )
      if (sidebarContainer) {
        state.scrollArea = sidebarContainer.querySelector(
          '[data-radix-scroll-area-viewport]',
        )
        state.sidebarScrollArea = sidebarContainer.querySelector(
          '[data-subposts-sidebar-scroll]',
        )

        if (state.scrollArea) {
          state.scrollArea.addEventListener(
            'scroll',
            SidebarScrollMask.update,
            { passive: true },
          )
        }

        requestAnimationFrame(() => {
          SidebarScroll.toActive()
          setTimeout(SidebarScrollMask.update, 100)
        })
      }
    }

    static cleanup() {
      if (state.scrollArea) {
        state.scrollArea.removeEventListener('scroll', SidebarScrollMask.update)
      }
      state.reset()
    }
  }

  document.addEventListener('astro:page-load', () => SidebarController.init())
  document.addEventListener('astro:after-swap', () => {
    SidebarController.cleanup()
    SidebarController.init()
  })
  document.addEventListener('astro:before-swap', () =>
    SidebarController.cleanup(),
  )
</script>
